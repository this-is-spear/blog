---
title: 6. 광고 클릭 이벤트 집계
date: '2024-05-06'
tags: ['책', '대규모 시스템 설계 기초 2']
draft: false
summary: 메시지 큐 원리를 알아보자.
images: []
---

### 1 단계 : 문제 이해 및 설계 범위 확장

**설계 범위 좁히기**

- 서비스 기준
  - 입력 데이터 형태
  - 데이터 양
  - 필요한 쿼리
  - 엣지 케이스
  - 지연 시간 요건

**요구사항 정제**

- 기능 요구사항 정제
  - 일정 시간 동안 클릭수 집계
  - 일정 시간 동안 많이 클릭된 상위 100개 광고 아이디 반환
  - 데이터 양은 페이스북이나 구글 규모
- 비기능 요구사항 정제
  - 집계 결과 정확성은 정산에 필요하므로 중요
  - 지연된거나 중복된 이벤트를 적절히 처리해야 함
  - 부분적인 장애를 견딜 견고성 필요함
  - 전체 처리 시간은 일정 시간 단위를 넘지 않아야 함

**일반적으로 요구되는 기능**

- 짧은 지연 시간
  - 갱신 지연 시간을 의도에 맞춰 **쉽게 줄일 수 있는 환경**이 만들어져야 한다.
- 확장성
  - 자원을 투자 비례해 성능 향상이 **쉽게** 되어야 한다.
- 유연성
  - 최소한 유지 보수 비용으로 기능 추가나 수정이 가능해야 한다.

### 2단계 : 개략적 설계안 제시 및 동의 구하기

**데이터 모델**

데이터 모델을 살펴보면 원시 데이터를 받게 되면 집계 결과를 계산한다. 사용자는 집계 결과만 확인하기 때문에 집계 결과만 저장하게 된다면 다음과 같은 문제가 발생한다.

- 원시 데이터가 존재하지 않으면 디버깅이 어렵다.
- 원시 데이터는 백업 데이터로 활용한다.
- 대용량 데이터 집합은 **예상 밖 인사이트**를 가지고 있는데 원시 데이터 활용도가 높다.

**비동기 처리**

생산자와 소비자 용량이 항상 같을 수 없다. 유동적인 트래픽에 대비하기 위해서는 생산자와 소비자 연결을 끊는게 좋다. 책에서는 카프카를 추천한다.

**집계 서비스**

맵리듀스 프레임워크를 사용한다. 맵리듀스에 좋은 모델은 유향 비순환 그래프(DAG)이다.
맵리듀스의 동작은 단순하다. 시스템을 노드 단위로 나누고 맵, 집계, 리듀스 작업으로 세분화한다.

- 맵 노드 : 데이터 필터링과 변환 역할을 담당한다.
- 집계 노드 : 메모리에서 데이터 집계를 담당한다.
- 리듀스 노드 : 산출 결과를 집계해 최종 결과로 축약한다.

유향 비순환 그래프 특징을 이용해 리듀스 결과를 계속 축약하다보면 원하는 결과가 나오게 된다.

> [유향 비순환 그래프(DAG)](https://ko.wikipedia.org/wiki/%EC%9C%A0%ED%96%A5_%EB%B9%84%EC%88%9C%ED%99%98_%EA%B7%B8%EB%9E%98%ED%94%84)는 방향 순환이 없는 무한 유향 그래프이다.
> 즉, 위상정렬이 있는 유향 그래프라고 보면 된다.
> 현실에서 사용 예는 스프레드 시트가 있다. 스프레드 시트는 각 셀을 참조하게 되며 최상위 셀 값을 수정하면 하위 셀 값들도 변경된다.

## 3단계 : 상세 설계

정리중

## 4단계 : 마무리

정리중
