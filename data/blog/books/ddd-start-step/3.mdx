---
title: 3. 애그리게이트 연동 학습과 실습
date: '2025-1-12'
tags: ['DDD', '스터디']
draft: false
summary: 아웃박스 패턴, 사가 패턴, 프로세스 매니저 패턴
images: []
---

## Introduction

도메인 주도 설계는 크게 전략적 설계와 전술적 설계로 나뉜다.
그 중 전략적 설계를 이해하고 적용하는 방법에 대해 정리한다.

해당 글에서는 애그리게이트 연동 설계를 정리한다.

<TOCInline toc={props.toc} exclude="Introduction" />

## 애그리게이트 연동 방법 정의

### 학습

> 언제 도메인 이벤트가 메시지 버스에서 발행되야 할까?

애그리게이트 연동에서 도메인 이벤트 발행 과정에서 트랜잭션 영역과 커밋, 롤백 여부를 구분하는 방법을 고민해야 한다.
아래처럼 극단적인 상황을 고민해야 한다.

- 도메인 이벤트 발행 후 트랜잭션 커밋 : 트랜잭션 커밋이 실패되면 일관성이 깨진다.
- 트랜잭션 커밋 후 도메인 이벤트 발행 : 도메인 이벤트 발행이 실패되면 일관성이 깨진다.

이런 경우를 다음 패턴으로 해결할 수 있다.

- 아웃박스 패턴 : 상태 변경과 이벤트 발행을 동일한 트랜잭션으로 처리한다. 발행 성공하면 이벤트를 완료 표시하고 발행에 실패하면 롤백한다.
- 사가 패턴 : 발행 단계 중 실패하면 시스템 일관성을 위해 적절한 보상 조치를 수행한다.

아웃박스 패턴은 메시지 릴레이와 데이터베이스를 활용해 구현한다.

- 데이터베이스 : 업데이트된 애그리게이트 상태와 도메인 이벤트를 동일한 트랜잭션으로 커밋한다.
- 메시지 릴레이 : 데이터베이스에 커밋된 도메인 이벤트를 가져온다. 이벤트를 가져오는 방식은 풀 또는 푸시 방식을 사용한다.

![이미지](/static/images/books/ddd-start-step/30.png)

> 메시지 릴레이가 풀 방식을 채택하면 데이터베이스에 지속적으로 질의한다.

사가 패턴은 관련 이벤트를 수신하고 후속 커맨드를 발행한다. 발행 단계 중 하나가 실패하면 시스템 유지를 위해 적절한 보상 조치를 수행한다.

![이미지](/static/images/books/ddd-start-step/31.png)

사가 패턴은 이벤트 소싱 애그리게이트로 구현되어 수신된 이벤트와 발행된 커맨드의 전체 기록을 유지한다.
도메인 이벤트 발행은 `사가 상태 전환 과정`을 `커맨드 실행 과정`과 분리하며 커맨드가 안정적으로 실행될 수 있도록 관리 가능하다.

- CommandIssuedEvent 이벤트, PublishingConfirmed, PublishingRejected 커맨드가 존재한다.
- CommandIssuedEvent는 발행된 커맨드를 이벤트 형태로 관리한다.
- PublishingConfirmed, PublishingRejected 는 발행된 커맨드를 의미한다.

| 이벤트를 수행하는 경우                                       | 이벤트를 롤백하는 경우                                       |
|----------------------------------------------------|----------------------------------------------------|
| ![이미지](/static/images/books/ddd-start-step/32.png) | ![이미지](/static/images/books/ddd-start-step/33.png) |

> 커맨드 실행 로직은 도메인 이벤트가 아웃박스 패턴으로 전달하는 방식과 유사하게 패턴 자체에서 벗어나 비동기적으로 실행된다.


### 결론

### 실습
