---
title: 9월 5주 있었던 일 정리
date: '2023-09-29'
tags: ['회고', '성능 개선', '테스트']
draft: false
summary: 프로젝트 성능 개선과 함께 테스팅
---

## Introduction

안녕! 이번 주는 연휴가 겹쳐 있어서 지난주에 아쉬웠던 부분을 메우는 시간을 가졌어.

<TOCInline toc={props.toc} exclude="Introduction" />

## 1. 성능 개선은 정말 어렵구나

### 1. 페이징

한 번 데이터를 조회할 때 `12,000건` 씩 조회되서 페이징을 고려했어.

가장 고민이 많았던 건 페이지를 얼만큼 나눌지 기준을 세우는 일이었어.
페이지 단위가 너무 적으면 데이터베이스 접근 레이턴시 횟수가 높아지고 I/O 비효율이 존재했고,
페이지 단위가 너무 크면 데이터베이스 읽기 레이턴시로 인해 커넥션을 얻기 위해 대기하는 친구들이 많아졌어.

`10,000`건으로 테스트를 수행했을 경우 커넥션을 획득하지 못해 커넥션 획득 시간인 `3초`를 넘어가면서 예외가 발생하더라,,,
그래서 `1,000건`으로 변경한 다음 테스트를 수행하니 문제가 발생하지 않았어.

> 이 과정에서 페이지 단위를 계속 수정하는 번거로움이 존재하더라구. 그래서 실행할 때 조절할 수 있도록 환경변수로 추출했어!

처음에는 `성능이 좋아지겠지!`라는 무식한 생각으로 접근 했는데,
읽는게 빨라지는 게 아니라 느려지지 않게 하기 위한 방법이라는 것을 체감하게 됐어.

막역하게 `성능이 좋아진다.`, `효율이 좋아진다.` 이런 말들을 습관적으로 내뱉었는데, 왜 좋아지는지 모르고 남발했던 것 같애.
반성 해야겠어.

### 2. Redis 사용 그러나 미약한 성능 개선

현재 작업 프로세스는 폴더 단위로 사용자의 정보들을 저장한 다음 압축해서 전달하는 과정을 거치고 있어.
이러한 과정 속에서 `파일 I/O` 횟수를 줄이기 위해 레디스에 데이터를 모아뒀다가 한 번에 압축하도록 수정하는게 빨라짐을 예상 할 수 있었어.
결과적으로 `파일 I/O` 를 `1/3`로 줄여 다음처럼 성능이 개선됐어.

> ![차트](/static/images/9m5w/chart.png)

생각했던 것보다 드라마틱한 효과는 없더라.
`파일 I/O 횟수`보다 `데이터베이스 접근 횟수`가 더 많아서 생기는 문제로 보였어.

현재 프로세스의 큰 문제는 데이터베이스에서 데이터를 조회하는 레이턴시였고,
이 과정에서 성능을 개선하기 위해서 비율이 가장 높은 작업을 찾아 개선을 해야 함을 깨달았어.

### 3. 간헐적으로 발생하는 SQLTransientConnectionException

`1번`과 `2번` 과정에서 느낀건 `속도를 빠르게 하기 위해서는 비율이 가장 높은 작업을 빠르게 해결해야 한다.`였어.
그래서 작업 비율이 가장 높은 SQL 실행 과정을 병렬로 실행하게 됐어.

어떻게 했냐면 SQL 문을 병렬로 실행해 여러 개의 리스트를 가져와 `Thread-safe` 한 컬렉션에 담도록 구현했어.
구현한 코드는 다음과 같아.

```java
final var collections = new ConcurrentLinkedQueue<Feed>();

IntStream.range(0, page + 1).parallel()
    .forEach(p -> feeds.addAll(getCollection(groupSeq, userSeq, pageSize, p * pageSize)));
```

> 이때 값을 추가하거나 값을 이터레이션 도는 경우가 많아 큐가 적합해 보였어.
> 만약 배열을 사용했다면 값을 추가하는 과정이 느리고 메모리 낭비도 심했을 듯 해.

배치를 돌리는 중에 `SQLTransientConnectionException` 예외가 터졌어. 커넥션을 얻기 위해 `30초` 이상을 기다려서 문제가 발생한 듯 해.
실은 이 문제가 `1번`에서 터졌던 문제야. 즉, 커넥션을 얻으려고 기다리는 시간이 길어지다 보니 이런 문제가 발생하나봐.
그래서 커넥션 대기 시간을 늘릴지 커넥션 풀을 늘릴지 아니면 병렬 처리를 수행하는 스레드를 제한할 지 고민이 많았어.

## 2. (직성중) 실무와 테스트

### 1. (직성중) 정책을 이해하는 것도 정말 중요하구나

- 정책 오류는 테스트로 잡기 어려웠어.
- 현재까지 느슨한 정책으로 수월하게 프로젝트를 구성했지만, 오픈에 가까워지면서 `이러면 사용자들이 불편하지 않을까?` 이런 고민들을 하게 됐어.
- 뒤늦게 발생하는 고민들이지만, 내가 불편하더라도 사용자들이 편한게 맞다는 생각이 들었다. 솔직히 열심히 만든건데 사용자들이 안써주는게 더 싫더라...

### 2. (직성중) 정말 필요한 테스트가 무엇일까?

- 여유가 생기면 꼼꼼해지더라. 일정이 급할 때는 이슈를 급급하게 쳐냈는데 지금은 아니야.
- 여유가 생긴 지금은 `테스트를 추가해 쉽게 확인 할 수 있지 않나?`, `이 관심사는 격리해서 관리하는게 앞으로 편하지 않을까?` 이런 고민을 할 수 있었어.

### 3. (직성중) 격리의 중요성을 체감함

- 관리가 쉬워지고 테스트 작성이 수월해졌어.

### 4. (직성중) 책을 읽으면서

- 소프트웨어 테스팅 책을 읽으면서...

## 3. (직성중) 마지막으로

- 실무를 경험하면서 모든 상황에서 트레이드 오프를 고려해야하는 복잡함을 느겼어.
- 또한 성능 개선은 꾸준함을 느꼈어. 해도해도 개선 할 부분이 계속 나오더라.
- 결정을 내릴 때마다 더 좋은 방법이 있지 않을까 하는 아쉬움이 남았어. 결정 과정에서 복잡성을 낮추고 업무 이해를 높이기 위해서는 주변 지식이 풍부해야 함을 느꼈어.
- 시스템 아키텍처를 그릴 수 있는 안목과 아키텍처를 구현 할 수 있는 구현력이 필요해서 연휴간 여러 아키텍처에 필요한 시스템 구현을 배워볼 생각이야.

