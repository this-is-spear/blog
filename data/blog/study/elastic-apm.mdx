---
title: elastic 8 apm ì„¤ì • ê³¼ì •
date: '2024-07-02'
tags: ['ê°œë…', 'apm', 'elasticsearch']
draft: false
summary: elastic version 8ì—ì„œ agent í™œìš©í•˜ëŠ” ë°©ë²• ì •ë¦¬
images: []
---

### Introduction

<TOCInline toc={props.toc} exclude="Introduction" />

### ê°œìš”

ì‚¬ë‚´ì—ì„œ apm ì„ self-hosted í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ì—ˆê³  ê°œì¸ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆë‹¤. ìš´ì˜ í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ëŠ” elasticsearchëŠ” 8.14ì—¬ì„œ 8.14 ì— ë§ê²Œ í…ŒìŠ¤íŠ¸í–ˆë‹¤. apm ì„ ì„¤ì •í•˜ë ¤ë©´ ìš°ì„  `apm server`ë¥¼ ê°€ìš©í• ì§€ `elastic agent`ë¥¼ ê°€ìš©í• ì§€ ê³ ë¯¼í•´ì•¼ í•œë‹¤.

- apm-server ì‚¬ìš© : 7.X ë²„ì „ ì´í•˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤. 8.X ë²„ì „ë¶€í„°ëŠ” APM integrationì„ ì„¤ì •í•´ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•´ì•¼ í•œë‹¤.
- elastic-agent ì‚¬ìš© : agent ê°€ apm serverë¥¼ ê´€ë¦¬í•œë‹¤. ë³„ê°œë¡œ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

![https://www.elastic.co/guide/en/apm/guide/8.11/getting-started-apm-server.html](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.03.14.png)

[ì°¸ê³  ìë£Œ](https://www.elastic.co/guide/en/apm/guide/8.11/getting-started-apm-server.html)

ì–´ë–¤ ë°©ì‹ì„ ì‚¬ìš©í• ì§€ëŠ” ë‹¤ìŒ ì˜ì‚¬ ê²°ì • ëª¨ë¸ë¡œ ê²°ì •í•˜ë©´ ëœë‹¤. í•„ìëŠ” RUMì„ ì‚¬ìš©í•˜ë©´ì„œ ë‹¤ë¥¸ í†µí•© ê¸°ëŠ¥ì„ ì‚¬ìš©í• ê±°ê¸°ì— ì¤‘ì•™ì—ì„œ ê´€ë¦¬ë˜ëŠ” `agent` íˆ´ì„ ì‚¬ìš©í•  ìƒê°ì´ë‹¤.

![https://www.elastic.co/guide/en/apm/guide/8.11/getting-started-apm-server.html](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.03.01.png)

[ì°¸ê³  ìë£Œ](https://www.elastic.co/guide/en/apm/guide/8.11/getting-started-apm-server.html)

í•˜ì§€ë§Œ ì´ë²ˆ ê¸°íšŒì— ì—¬ëŸ¬ ë°©ë©´ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œì§€ í…ŒìŠ¤íŠ¸í•´ë³´ê¸° ìœ„í•´ apm server ë¶€í„° í…ŒìŠ¤íŠ¸í–ˆë‹¤.

### Self-hosted apm server

**`Agent Policy APM Server`** ì— ì„¤ì •ëœ ë²„ì „ì— ë§ê²Œ `apm server`ë¥¼ ì„¤ì¹˜í•œë‹¤. í•„ìëŠ” `8.11.3`ì— ë§ê²Œ ì„¤ì¹˜í–ˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 7.20.52.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.20.52.png)


ë‹¤ìŒì²˜ëŸ¼ ì„¤ì¹˜í•œ í›„ì— ë””ë ‰í† ë¦¬ì— ì¡´ì¬í•˜ëŠ” apm-server.yml ë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

```bash
curl -L -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.11.3-darwin-x86_64.tar.gz
tar xzvf apm-server-8.11.3-darwin-x86_64.tar.gz
cd apm-server-8.11.3-darwin-x86_64
```

`apm-server.yml`ì—ì„œ ìˆ˜ì •í•  ë¶€ë¶„ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- apm-server.host
- output.elasticsearch.hosts
- output.elasticsearch.username
- output.elasticsearch.password

`output.elasticsearch.hosts` ê°’ì€ ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•˜ë‹ˆ ì£¼ì˜í•˜ì.

```bash
######################### APM Server Configuration #########################

################################ APM Server ################################

apm-server:
  # Defines the host and port the server is listening on. Use "unix:/path/to.sock" to listen on a unix domain socket.
  host: "127.0.0.1:8200"

#================================ Outputs =================================

# Configure the output to use when sending the data collected by apm-server.

#-------------------------- Elasticsearch output --------------------------
output.elasticsearch:
  # Array of hosts to connect to.
  # Scheme and port can be left out and will be set to the default (`http` and `9200`).
  # In case you specify and additional path, the scheme is required: `http://localhost:9200/path`.
  # IPv6 addresses should always be defined as: `https://[2001:db8::1]:9200`.
  hosts: ["localhost:9200"]

  # Authentication credentials - either API key or username/password.
  #api_key: "id:api_key"
  username: "elastic"
  password: "pass"

```

ì„¤ì •ì„ ì™„ë£Œí–ˆë‹¤ë©´ `apm server`ë¥¼ ì‹¤í–‰í•˜ë©´ ì™„ë£Œë‹¤. ì´ì œëŠ” ì‹¤í–‰ í›„ ë¡œê·¸ë¥¼ ì‚´í´ë³´ë©´ì„œ ì—°ê²°ëëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤.

```bash
./apm-server -e
```

ì •ìƒ ì‹¤í–‰ëëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ apm serverë¡œ `GET /` ìš”ì²­ì„ ë³´ë‚´ë©´ ëœë‹¤. `publish_ready`ê°€ `true`ë©´ ìš”ì²­ ë°›ì„ ì¤€ë¹„ê°€ ëœ ê²ƒì´ë‹¤.

```
curl http://localhost:8200

{
  "build_date": "2023-12-07T11:11:14-05:00",
  "build_sha": "cba21e88bd0d376ec77dc77fccccfdc0c27206ac",
  "publish_ready": true,
  "version": "8.11.3"
}

```

### Self-hosted apm server íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 1 -  precondition failed: error querying cluster_uuid: status_code=401

ì¸ì¦ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ì„ ë•Œ ë°œìƒí•˜ë©° `username`, `password` ë˜ëŠ” `api key`ê°€ ì •ìƒì¸ì§€ í™•ì¸í•´ì•¼ í•œë‹¤.

```
{
	"log.level":"error",
	"@timestamp":"2024-06-30T22:13:11.224Z",
	"log.logger":"beater",
	"log.origin":{"file.name":"beater/waitready.go","file.line":64},
	"message":"precondition failed: error querying cluster_uuid: status_code=401",
	"service.name":"apm-server",
	"ecs.version":"1.6.0"
}
```

`api key`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ `id:api_key` í˜•ì‹ìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•˜ë©° `elasticsearch` ì—ì„œ `xpack.security.authc.api_key.enabled`ê°€ `true`ë¡œ ì„¤ì •ë˜ì–´ì•¼ í•œë‹¤. (ê¸°ë³¸ê°’ `true`)

ë°œê¸‰ ë°©ì‹ì€ ë‹¤ìŒì²˜ëŸ¼ ìœ íš¨ê¸°ê°„ê³¼ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ í•œì •í•˜ë©´ ëœë‹¤.

```
curl -X POST -u elastic:password "localhost:9200/_security/api_key?pretty" -H 'Content-Type: application/json' -d'
{
  "name": "my-api-key",
  "expiration": "1d",
  "role_descriptors": {
	    "apm_writer": {
	        "index": [
	            {
	                "names": ["apm-*"],
	                "privileges": ["create_index", "create_doc"]
	            }
	        ]
	    },
	    "apm_sourcemap": {
	        "index": [
	            {
	                "names": [".apm-source-map"],
	                "privileges": ["read"]
	            }
	        ]
	    },
	    "apm_agentcfg": {
	        "index": [
	            {
	                "names": [".apm-agent-configuration"],
	                "privileges": ["read"]
	            }
	        ]
	    }
  },
  "metadata": {
    "application": "my-application",
    "environment": {
       "level": 1,
       "trusted": true,
       "tags": ["dev", "staging"]
    }
  }
}
'

```

api key ê´€ë ¨í•´ì„œëŠ” [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/observability/current/apm-beats-api-keys.html)ì„ ì°¸ê³ í•˜ì. ê·¸ëŸ¼ ë‹¤ìŒì²˜ëŸ¼ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë‹¤.

```
{
  "id" : "PBt_c5ABPp00qxZHzw2z",
  "name" : "my-api-key",
  "expiration" : 1720011074501,
  "api_key" : "Ho03mwqqQ3mLYfDAYjOiQg",
  "encoded" : "UEJ0X2M1QUJQcDAwcXhaSHp3Mno6SG8wM213cXFRM21MWWZEQVlqT2lRZw=="
}
```

ì´ ë•Œ ì£¼ì˜í•  ì ì€ `output.elasticsearch.api_key` ì„¤ì • ê°’ì—ëŠ” `id:api_key` í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤ëŠ” ì ì´ë‹¤. ì¦‰ ìœ„ ì •ë³´ë¡œ ì¡°í•©í–ˆì„ ë•Œ`PBt_c5ABPp00qxZHzw2z:Ho03mwqqQ3mLYfDAYjOiQg` ê°’ì´ ì¶”ê°€ë˜ì–´ì•¼ í•œë‹¤.

ê°„ë‹¨í•˜ê²Œ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ë‹¤ë©´ ì‚¬ìš©ì ì •ë³´ë¡œ ì‹¤í–‰í•˜ë©´ ë˜ì§€ë§Œ ìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê³µìœ ëŠ” ë¶€ë‹´ìŠ¤ëŸ½ë‹¤. ê·¸ëŸ° ìƒí™©ì€ í•´ë‹¹ ë°©ì‹ì„ ì‚¬ìš©í•˜ì.

### Self-hosted apm server íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 2 -  precondition 'apm integration installed'

`apm integration` ì„¤ì •ì„ í•˜ì§€ ì•Šê³  `apm`ì— ì—°ê²°í•˜ë ¤ í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤. ë§Œì•½ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ fleet â†’ agent policies ì—ì„œ `apm integration`ì„ ì¶”ê°€í•œë‹¤.

```
{
"log.level":"error",
"@timestamp":"2024-07-01T00:58:10.258Z",
"log.logger":"beater",
"log.origin":{"function":"github.com/elastic/apm-server/internal/beater.waitReady","file.name":"beater/waitready.go","file.line":62},
"message":"precondition 'apm integration installed' failed: error querying Elasticsearch for integration index templates: unexpected HTTP status: 404 Not Found ({\"error\":{\"root_cause\":[{\"type\":\"resource_not_found_exception\",\"reason\":\"index template matching [logs-apm.error] not found\"}],\"type\":\"resource_not_found_exception\",\"reason\":\"index template matching [logs-apm.error] not found\"},\"status\":404}): to remediate, please install the apm integration: https://ela.st/apm-integration-quickstart",
"service.name":"apm-server",
"ecs.version":"1.6.0"
}
```

ì—¬ê¸°ì—ì„œ í˜¼ë™í•˜ì§€ ë§ì•„ì•¼í•  ì ì€ agentë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ì‹¤í–‰ë˜ë‹ˆ agent ì„¤ì¹˜í•˜ëŠ” ê³¼ì •ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•œë‹¤.

ì‚¬ì‹¤ í•´ë‹¹ ì´ìŠˆëŠ” ë§Œë‚  ì¼ì´ ì—†ë‹¤. 8.14ë¥¼ ì²˜ìŒ ì„¤ì¹˜í•˜ê²Œ ë˜ë©´ apm policyì¸ **`Agent Policy APM Server`**ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.

![í•´ë‹¹ apm ploicyì— ë“¤ì–´ê°€ ìì‹ ì˜ apm hostë¥¼ ì„¤ì •í•´ì£¼ì.](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.24.33.png)

í•´ë‹¹ apm ploicyì— ë“¤ì–´ê°€ ìì‹ ì˜ apm hostë¥¼ ì„¤ì •í•´ì£¼ì.

### Self-hosted apm server íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 3 -  The APM integration must be upgraded.

`apm integration`ì— ë§ëŠ” ë²„ì „ì„ ì‹¤í–‰í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. elasticsearch, kibana ë²„ì „ 8.14ì— ë§ê²Œ ìœ ì§€í–ˆì§€ë§Œ `apm integration`ì—ì„œëŠ” ë‹¤ë¥¸ ë²„ì „ì´ ì„¤ì¹˜ë˜ì–´ ë°œìƒí–ˆë‹¤.

```
{
	"log.level":"error",
	"@timestamp":"2024-07-02T17:13:01.044+0900",
	"log.origin":{
			"function":"github.com/elastic/go-docappender.(*Appender).flush",
			"file.name":"go-docappender@v1.1.1/appender.go",
			"file.line":376
		},
	"message":"failed to index documents in 'metrics-apm.service_summary.1m-default' (fail_processor_exception): Document produced by APM Server v8.14.2, which is newer than the installed APM integration (v8.11.0-preview-1695749054). The APM integration must be upgraded.",
	"service.name":"apm-server",
	"documents":2,
	"ecs.version":"1.6.0"
}
```

`apm integration` ì— ì„¤ì •ëœ fleet â†’ agent policies â†’ í™•ì¸í•˜ë ¤ëŠ” integration ì„ íƒí•˜ë©´ í•´ë‹¹ í˜ì´ì§€ê°€ ì—´ë¦¬ê³  ë²„ì „ë„ í•´ë‹¹ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 7.20.52.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_7.20.52.png)

### Fleet managed apm server

`fleet managed apm server`ëŠ” `elastic agentë¡œ ê´€ë¦¬ë˜ëŠ” apm server ì‚¬ìš©`ì„ ì˜ë¯¸í•œë‹¤. fleetì„ í†µí•´ í•œ ê°œ ì´ìƒì˜ elastic agentë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆê³ , `elastic agent`ë¥¼ í†µí•´ `apm server`ë¥¼ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì¦‰, ì²˜ë¦¬ëŸ‰ ëŠ˜ì–´ë‚˜ëŠ” í˜„ìƒì„ ìŠ¤ì¼€ì¼ë§ìœ¼ë¡œ ì‰½ê²Œ í•´ê²° ê°€ëŠ¥í•˜ë‹¤.

ì´ë•Œ ì£¼ì˜í•  ì ì€ `RUM`ì„ ì‚¬ìš©í•˜ëŠ” ìƒí™©ì´ë‹¤. `RUM`ì„ ì‚¬ìš©í•  ë•Œì—ëŠ” ë™ì¼í•œ apm serverë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìŠ¤ì¼€ì¼ë§ìœ¼ë¡œ ì¬ë°°ì¹˜í•˜ëŠ” ê²½ìš°ë¥¼ ì‹ ê²½ì¨ì•¼ í•œë‹¤.

`fleet` ì„œë²„ ìƒì„±ì€ ìƒê°ë³´ë‹¤ ì‰½ë‹¤. ë‹¨ìˆœí•˜ê²Œ fleet managementì— ì ‘ì†í•´ Add Fleet Server ì ˆì°¨ë¥¼ ë”°ë¼ê°€ë©´ ëœë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 10.04.58.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.04.58.png)

fleet ì„œë²„ë¥¼ ë„ˆë¬´ ì–´ë µê²Œ ìƒê°í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ê·¸ëƒ¥ `elastic agent`ë¥¼ ê´€ë¦¬í•˜ëŠ” fleet ê¸°ëŠ¥ì„ ê°€ì§„ `elastic agnet`ë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 10.08.15.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.08.15.png)

Fleet Serverë¥¼ ë“±ë¡í•˜ë©´ ë‹¤ìŒì²˜ëŸ¼ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 10.18.21.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.18.21.png)

ì§€ê¸ˆì€ ì„œë²„ í•œ ëŒ€ë¡œ í…ŒìŠ¤íŠ¸í•˜ë‹¤ë³´ë‹ˆ ë™ì¼í•œ Agentë¥¼ ë‘ ê°œ ì´ìƒ ë„ìš¸ ìˆ˜ ì—†ì—ˆë‹¤. ê°„ë‹¨í•˜ê²Œ Fleet Server ì—†ì´ Agentë§Œ ë“±ë¡í•´ì„œ ì§„í–‰í•´ë³´ê² ë‹¤. Elastic Agentë¥¼ **`Run standalone`** í˜•ì‹ìœ¼ë¡œ ì‹¤í–‰í•˜ë©´ ëœë‹¤. ë‹¤ìŒ ì ˆì°¨ë¡œ Agentë¥¼ ì¶”ê°€í•˜ë©´ ëœë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 10.23.26.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.23.26.png)

ì •ìƒ ì‹¤í–‰ëëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ apm serverë¡œ `GET /` ìš”ì²­ì„ ë³´ë‚´ë©´ ëœë‹¤. `publish_ready`ê°€ `true`ë©´ ìš”ì²­ ë°›ì„ ì¤€ë¹„ê°€ ëœ ê²ƒì´ë‹¤.

```
curl http://localhost:8200

{
  "build_date": "2023-12-07T11:11:14-05:00",
  "build_sha": "cba21e88bd0d376ec77dc77fccccfdc0c27206ac",
  "publish_ready": true,
  "version": "8.11.3"
}
```

### Fleet managed apm server íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 1 : publish ready false

`Fleet Server`ëŠ” ë°°í¬ëœ `Elastic Agent` ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” í•˜ìœ„ í”„ë¡œì„¸ìŠ¤ì´ë‹ˆ í•´ë‹¹ `Elastic Agent`ë¡œ APM ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ ìƒê°í•  ìˆ˜ ìˆì§€ë§Œ ê·¸ë ‡ì§€ ì•Šë‹¤. í•´ë‹¹ ì—ì´ì „íŠ¸ëŠ” `Elastic Agent` í†µì‹  í˜¸ìŠ¤íŠ¸ë¡œ `Fleet Server`ë¥¼ ì‹¤í–‰í•˜ëŠ” ë° ì „ë…í•˜ë©° ë°ì´í„° ìˆ˜ì§‘ì„ ìœ„í•´ êµ¬ì„±ë˜ì§€ ì•ŠëŠ”ë‹¤.

`Fleet Server`ì—ì„œ `apm integration` ì„¤ì •ì„ ì§„í–‰í•˜ë©´ ë‹¤ìŒì²˜ëŸ¼ ì¤€ë¹„ê°€ ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ì´ìŠˆê°€ ë°œìƒí•œë‹¤.

```
curl http://localhost:8200

{
  "build_date": "...",
  "build_sha": "...",
  "publish_ready": false,
  "version": "..."
}
```

### Fleet managed apm server íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 2 : agnetê°€ ì¶”ê°€ ì•ˆë¼ìš”!

`Fleet Server`ëŠ” ë“±ë¡í•˜ìë§ˆì `Agents` ì— ìˆ«ìê°€ ì¹´ìš´íŒ…ë˜ì§€ë§Œ `Fleet Server` ì—†ì´ ì¶”ê°€í•˜ë©´ ì¹´ìš´íŒ…ë˜ì§€ ì•Šìœ¼ë‹ˆ ì‹ ê²½ì“°ì§€ ë§ì.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-02 á„‹á…©á„’á…® 10.32.03.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-02_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.32.03.png)

ëŒ€ë¶€ë¶„ì˜ Agent ê´€ë¦¬ ê¸°ëŠ¥ì€ Fleet Serverê°€ ìˆì–´ì•¼ ê°€ëŠ¥í•˜ë‹ˆ ì´ëŸ° ìƒí™©ì´ ë°œìƒí•´ë„ ê·¸ë ¤ëŸ¬ë‹ˆ í•´ì•¼ í•œë‹¤. ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ëŠ” í•´ë‹¹ í¬íŠ¸ë¡œ ìš”ì²­ì„ ë³´ë‚´ì„œ í™•ì¸í•˜ì.

```
curl http://localhost:8200

{
  "build_date": "2023-12-07T11:11:14-05:00",
  "build_sha": "cba21e88bd0d376ec77dc77fccccfdc0c27206ac",
  "publish_ready": true,
  "version": "8.11.3"
}
```

### Apm agentì˜ ê°€ëŠ¥ì„±

`apm agent`ì—ëŠ” `metricbeats`, `filebeats`, `apm` ë“±ì„ êµ¬ì„±í•  ìˆ˜ ìˆê³ , `inputs`ì— ì›í•˜ëŠ” ì…ë ¥ì„ ì¶”ê°€í•˜ë©´ ì‰½ê²Œ í•¸ë“¤ë§ ê°€ëŠ¥í•´ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë°©ì•ˆì´ ë§ë‹¤. ë‹¤ìŒì²˜ëŸ¼ inputsì— ì›í•˜ëŠ” ì…ë ¥ í˜•íƒœë¥¼ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```
...

inputs:
  - type: filestream
    id: unique-id-per-input
    paths:
      - /var/log/my-application/log-file.log
```

https://www.elastic.co/guide/en/fleet/current/elastic-agent-simplified-input-configuration.html

ì•„ë‹ˆë©´ filebeatë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„ **`log_sending`** ì˜µì…˜ì„ ì´ìš©í•´ apmìœ¼ë¡œ ë¡œê·¸ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆë‹¤. [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/apm/agent/java/current/config-logging.html#config-log-sending)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ, ì¼ë¶€ ë¡œê·¸ê°€ ìœ ì‹¤ë  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì.

ë§Œì•½ MDCë¥¼ ì§€ì›í•˜ê³  ì‹¶ë‹¤ë©´ **`log_ecs_reformatting` ì˜µì…˜ì„ ì´ìš©í•˜ë©´ ëœë‹¤.** [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/apm/agent/java/current/config-logging.html#config-log-ecs-reformatting)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


### í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì—ì´ì „íŠ¸ ë“±ë¡

í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì—ì´ì „íŠ¸ë¥¼ ë“±ë¡í•˜ëŠ” ë°©ë²•ì€ ë‹¤ì–‘í•˜ì§€ë§Œ í•„ìëŠ” í”„ë¡œì íŠ¸ì— ë¹„ì¦ˆë‹ˆìŠ¤ì™€ ê´€ë ¨ë˜ì§€ ì•Šì€ ì½”ë“œëŠ” ì¶”ê°€í•˜ê³  ì‹¶ì§€ ì•Šì•˜ë‹¤. ê·¸ë˜ì„œ ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“œëŠ” ì‹œì ì— ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆë‹¤.

```Dockerfile
FROM amazoncorretto:17

COPY --from=docker.elastic.co/observability/apm-agent-java:1.50.0 /usr/agent/elastic-apm-agent.jar /elastic-apm-agent.jar

ARG JAR_FILE=build/libs/*.jar
ENV APM_ENVIRONMENT="dev"
ENV APM_SERVER_URL="http://apm-server:8200"
ENV APM_TOKEN=""
COPY ${JAR_FILE} app.jar

CMD java -javaagent:elastic-apm-agent.jar \
    -Delastic.apm.service_name=service-api \
    -Delastic.apm.secret_token=$APM_TOKEN \
    -Delastic.apm.server_url=$APM_SERVER_URL \
    -Delastic.apm.environment=$APM_ENVIRONMENT \
    -Delastic.apm.application_packages=com.hello \
    -jar app.jar
```

ì‚¬ìš©í•  ìˆ˜ ìˆì„ë²•í•œ ì˜µì…˜ê³¼ í•¨ê»˜ ì„¤ëª…ì„ ì •ë¦¬í–ˆë‹¤.

| í™˜ê²½ ì„¤ì • ì •ë³´                                         | ì„¤ëª…                                                                                                                                                       | ì˜ˆì‹œ                     |
|--------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
| elastic.apm.service_name                         | ì„œë¹„ìŠ¤ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì´ë¦„ì„ ì„¤ì •í•œë‹¤.                                                                                                                                  | member-api             |
| elastic.apm.environment                          | í•´ë‹¹ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ëŠ” í™˜ê²½ì„ ì˜ë¯¸í•œë‹¤. dev, aplus-test, aplus-qa, aplus-stage, aplus-prod                                                                                | dev                    |
| elastic.apm.server_url                           | apm ì´ ì„¸íŒ…ëœ URLì„ ì˜ë¯¸í•œë‹¤. dev, test, qa í™˜ê²½ì€ http://10.9.25.4:8200 ì— ìœ„ì¹˜í•œë‹¤.                                                                                     | http://apm-server:8200 |
| elastic.apm.secret_token                         | ì—°ê²°ì— í•„ìš”í•œ secret token ê°’ì´ë©° apm integrationì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.                                                                                                     |                        |
| elastic.apm.application_packages                 | ì—°ê²°í•  ì„œë¹„ìŠ¤ì˜ application íŒ¨í‚¤ì§€ëª…ì´ë‹¤. ì»¨í…ìŠ¤íŠ¸ ì„œì¹˜ê°€ ë˜ëŠ” ë£¨íŠ¸ íŒ¨í‚¤ì§€ë¡œ ì„¤ì •í•œë‹¤.                                                                                                   | com.hello              |
| elastic.apm.enable_experimental_instrumentations | experimental ê¸°ëŠ¥ì„ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ì˜µì…”ì´ë‹¤. experimental ê¸°ëŠ¥ì„ ì‚¬ìš©í•œë‹¤ë©´ ê¼­ ì¶”ê°€í•´ì•¼ í•œë‹¤.                                                                                       | true                   |
| elastic.apm.log_sending                          | ë¡œê·¸ë¥¼ ì§ì ‘ ì „ì†¡í•˜ëŠ” ë°©ë²•ì´ë‹¤. Filebeatë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ ì¢‹ì§€ë§Œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì¶”ê°€í•´ë„ ì¢‹ë‹¤. - https://www.elastic.co/guide/en/apm/agent/java/current/config-logging.html#config-log-sending | true                   |

### í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì—ì´ì „íŠ¸ ë“±ë¡ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 1 - Route Unkown

í•´ë‹¹ í˜•ì‹ì²˜ëŸ¼ ì–´ë–¤ ìš”ì²­ì„ ë°›ì•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ì–´ë ¤ìš´ ìƒí™©ì´ ìˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-03 á„‹á…©á„’á…® 10.15.18.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-03_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.15.18.png)

APMì€ ìš”ì²­ì„ ì²˜ë¦¬í•œ ì„œë¸”ë¦¿ ì´ë¦„ìœ¼ë¡œ ë¶„ë¥˜í•˜ê²Œ ë˜ëŠ”ë° ì„œë¸”ë¦¿ì— ë„ë‹¬í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ í˜•ì‹ìœ¼ë¡œ ì§€ì •ëœë‹¤. `Spring Cloud Gateway`ëŠ” ì„±ëŠ¥ì„ ìœ„í•´ ì„œë¸”ë¦¿ì„ ê±°ì¹˜ì§€ ì•Šê³  ë¼ìš°íŒ…í•˜ê²Œ ë˜ì–´ ì„œë¸”ë¦¿ ì´ë¦„ì„ ì„¤ì •í•  ìˆ˜ ì—†ê²Œ ëœë‹¤. ê´€ë ¨ ê¸€ì€ [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/apm/agent/java/current/trouble-shooting.html#trouble-shooting-unknown-route)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

ì´ëŸ° ê²½ìš° `java agent`ì—ì„œ [elastic.apm.use_path_as_transaction_name](https://www.elastic.co/guide/en/apm/agent/java/current/config-http.html#config-use-path-as-transaction-name) í”Œë˜ê·¸ë¥¼ `true`ë¡œ ì„¤ì •í•˜ë©´ ëœë‹¤. ë‹¤ë§Œ URL ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë˜ê²Œ ë˜ëŠ”ë° path parameterê°€ ì¶”ê°€ë˜ë©´ ëŒ€ëŸ‰ íŠ¸ëœì­ì…˜ì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•´ì•¼ í•œë‹¤. ì´ëŸ° ê²½ìš° [url groups](https://www.elastic.co/guide/en/apm/agent/java/current/config-http.html#config-url-groups)ë¥¼ ì´ìš©í•´ íŠ¸ëœì­ì…˜ì´ ëŒ€ëŸ‰ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì.

### ìš´ì˜í™˜ê²½ ì´ìŠˆ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 1 - Data too large

ìš´ì˜ í™˜ê²½ `kibana`ì— ì ‘ì†í•˜ìë§ˆì í•´ë‹¹ ì´ìŠˆì™€ ë§ë”±ëœ¨ë ¸ë‹¤. 15ë¶„ ê°„ê²©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ í—ˆìš©ëœ í¬ê¸°ë³´ë‹¤ 10MB ì´ˆê³¼í•´ì„œ ìš”ì²­ì´ ì¤‘ë‹¨ëë‹¤.

```
Error while fetching resource

Error
[parent] Data too large, data for [<http_request>] would be [1034040064/986.1mb],
which is larger than the limit of [1020054732/972.7mb], real usage: [1034040064/986.1mb],
new bytes reserved: [0/0b],
usages [model_inference=0/0b, inflight_requests=0/0b, request=0/0b, fielddata=52192/50.9kb, eql_sequence=0/0b]:
circuit_breaking_exception Root causes: circuit_breaking_exception: [parent] Data too large, data for [<http_request>] would be [1034040064/986.1mb],
which is larger than the limit of [1020054732/972.7mb],
real usage: [1034040064/986.1mb], new bytes reserved: [0/0b], usages [model_inference=0/0b, inflight_requests=0/0b, request=0/0b, fielddata=52192/50.9kb, eql_sequence=0/0b] (429)

URL
https://host/internal/apm/fallback_to_transactions?kuery=&start=2024-07-03T10%3A14%3A34.049Z&end=2024-07-03T10%3A29%3A34.049Z
```

ë‹¤ìŒ ì´ìŠˆì—ì„œ `circuit_breaking_exception` ì„ì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. [í•´ë‹¹ ê¸€](https://discuss.elastic.co/t/finding-out-cause-of-circuit-breaking-exception-data-too-large/351217/3)ì—ì„œëŠ” `OOM`ì„ ë§‰ê¸° ìœ„í•´ ì œí•œì´ ê±¸ë¦¬ê¸° ë•Œë¬¸ì— ì œí•œ ì„¤ì •ì„ ë³€ê²½í•˜ì§€ ì•Šì•„ì•¼ í•˜ë©° ìš”ì²­ì„ ë¶„í• í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  í•„ìš”í•¨ì„ ì•Œê²Œ ëë‹¤.

```
Error

[circuit_breaking_exception Root causes: circuit_breaking_exception:
[parent] Data too large,
data for [<http_request>] would be [1023057920/975.6mb],
which is larger than the limit of [1020054732/972.7mb],
real usage: [1023057920/975.6mb], new bytes reserved: [0/0b], usages [model_inference=0/0b, inflight_requests=0/0b, request=0/0b, fielddata=57630/56.2kb, eql_sequence=0/0b]]:

[parent] Data too large,
data for [<http_request>] would be [1023057920/975.6mb],
which is larger than the limit of [1020054732/972.7mb],
real usage: [1023057920/975.6mb], new bytes reserved: [0/0b], usages [model_inference=0/0b, inflight_requests=0/0b, request=0/0b, fielddata=57630/56.2kb, eql_sequence=0/0b] (429)

```

ê·¸ëŸ¼ ìƒê°í•  ìˆ˜ ìˆëŠ” ë‚´ìš©ì€ JVM ì œí•œì— ë§ê²Œ ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ ê±¸ë¦¬ê³  ìš”ì²­ ë¶„í• ë¡œ í•´ê²° í•  ìˆ˜ ìˆìŒì„ ë‚˜íƒ€ë‚¸ë‹¤. ì²« ë²ˆì§¸ë¡œ JVM ê´€ë ¨ ì„¤ì •ì„ ì œì–´í•˜ëŠ” ë°©ë²•ì„ ê³ ë ¤í–ˆë‹¤. [í•´ë‹¹ ê¸€](https://github.com/elastic/elasticsearch/issues/31197)ì—ì„œëŠ” ì œí•œì„ ìˆ˜ì •í•˜ëŠ” ë°©ì‹ì„ ì œì•ˆí–ˆë‹¤.

```
curl -X PUT "localhost:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
 {
     "transient" : {
         "indices.breaker.total.limit" : "80%"
     }
 }
 '
```

ì´ëŸ°ì €ëŸ° ê¸€ì„ ì°¾ì•„ë³´ë‹ˆ JVM í—ˆìš©ëŸ‰ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒí•œì„ ì´ ì •í•´ì§€ê²Œ ë˜ëŠ”ë°, ìš´ì˜ í™˜ê²½ ES ì‚¬ì´ì¦ˆê°€ ë„ˆë¬´ ì‘ì•„ ë°œìƒí•˜ëŠ” ë¬¸ì œì²˜ëŸ¼ ë³´ì¸ë‹¤.

ğŸ› ï¸ìš´ì˜ í™˜ê²½ ë¶„ì„ í•„ìš”

### ìš´ì˜í™˜ê²½ ì´ìŠˆ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… 2 - ëŠ˜ì–´ë‚˜ëŠ” ë°ì´í„°ì…‹

JVM ë¦¬ì†ŒìŠ¤ë„ ê±±ì •ë˜ëŠ”ë° ì €ì¥ ê³µê°„ì€ ê´œì°®ì„ê¹Œ ìš°ë ¤ëë‹¤. ìµœê·¼ ì‹ ê·œ ì„œë¹„ìŠ¤ë¥¼ ëŸ°ì¹­í•˜ë©´ì„œ `APM`ì´ ì¶”ê°€ëëŠ”ë° 6ì›” 2ì¼ë¶€í„° 7ì›” 3ì¼ê¹Œì§€ ì ì¬ëœ ì–‘ë§Œ `81GB`ë‹¤. ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë˜ë©´ ìŒ“ì´ëŠ” ì–‘ì´ 3ë°° ê°€ê¹Œì´ ëŠ˜ì–´ë‚˜ê²Œ ë˜ë‹ˆ ëŒ€ì±…ì„ ë¯¸ë¦¬ ê°•êµ¬í•´ì•¼ í•œë‹¤. ê³ ë¯¼ í¬ì¸íŠ¸ëŠ” ì„¸ ê°€ì§€ë‹¤.

- ìŠ¤íŒ¬ ì••ì¶•
- ìƒ˜í”Œë§ ê´€ë¦¬
- ì¸ë±ìŠ¤ ë¼ì´í”„ì‚¬ì´í´ ì„¤ì •

ìŠ¤íŒ¬ ì••ì¶• ë¨¼ì € ì‚´í´ë³´ìë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ì¡°í•©í•˜ëŠ” ê²½ìš° ë‘ ê°œ ì´ìƒì˜ SQLì´ ì‹¤í–‰ë˜ë©´ì„œ ë‹¤ëŸ‰ì˜ ìŠ¤íŒ¬ì´ ìƒì„±ë  ìˆ˜ ìˆë‹¤. ì´ëŸ° ê²½ìš° ë³µì¡í•˜ê¸°ë§Œ í•˜ê³  í•œ ëˆˆì— íŒŒì•…í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆë‹¤. ì´ëŸ° ê²½ìš° `(1) ê°™ì€ ìœ í˜•` ì´ê±°ë‚˜ `(2) ë™ì¼í•œ ì •ë³´`ë¥¼ ê°€ì§€ê±°ë‚˜ íŒ¨í„´ì„ ë¶„ì„í•´ ì••ì¶•ì„ ì§„í–‰í•œë‹¤.

ê°™ì€ ìœ í˜•ì¸ì§€ëŠ” ìŠ¤íŒ¬ì˜ íƒ€ì…ê³¼ ì ‘ê·¼í•˜ëŠ” ë¦¬ì†ŒìŠ¤ë¡œ íŒŒì•…í•˜ë©° ë™ì¼í•œì§€ëŠ” ìŠ¤íŒ¬ ê°’ì„ í™•ì¸í•´ì„œ íŒë‹¨í•œë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/observability/8.12/span-compression.html)ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

- [`span_compression_same_kind_max_duration`](https://www.elastic.co/guide/en/apm/agent/java/1.x/config-huge-traces.html#config-span-compression-same-kind-max-duration)  : ì£¼ë³€ ìŠ¤íŒ¬ ì •ë³´ì™€ ìœ ì‚¬í•œ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì˜ë¯¸í•˜ë©° ë™ì¼í•œ spanì„ ê°€ì§„ë‹¤ë©´ ê°™ì€ ì‘ì—…ìœ¼ë¡œ ì¸ì‹í•œë‹¤. ê¸°ë³¸ ê°’ì€ `0ms`ì´ë‹¤.
- [`span_compression_exact_match_max_duration`](https://www.elastic.co/guide/en/apm/agent/java/1.x/config-huge-traces.html#config-span-compression-exact-match-max-duration) : ìŠ¤íŒ¬ ê°’ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ì˜ë¯¸í•˜ë©° ì¼ì • ê¸°ê°„ ë‚´ì— ë™ì¼í•œ spanì„ ê°€ì§„ë‹¤ë©´ ê°™ì€ ì‘ì—…ìœ¼ë¡œ ì¸ì‹í•œë‹¤. ê¸°ë³¸ ê°’ì€ `50ms`ì´ë‹¤.

<aside>
    ğŸš§ ìŠ¤íŒ¬ ì••ì¶•ì˜ ë‹¨ì ì€ SQLì´ ìˆ˜ì§‘ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì´ë‹¤. ì£¼ì˜í•˜ì.

</aside>

ìƒ˜í”Œë§ì„ ê´€ë¦¬í•˜ê²Œ ë˜ë©´ ë°ì´í„° ì–‘ê³¼ ë¶„ì„ì— í•„ìš”í•œ ë…¸ë ¥ì„ íšê¸°ì ìœ¼ë¡œ ì¤„ì¼ ìˆ˜ ìˆë‹¤. ìƒ˜í”Œë§ ë•ë¶„ì— ë¹„ì •ìƒì ì¸ íŒ¨í„´ì„ ì‰½ê²Œ ê´€ë¦¬í•˜ê³  ë³µêµ¬ ì‹œê°„ ë˜í•œ ë‚®ì¶œ ìˆ˜ ìˆë‹¤. APMì€ `head-based sampling` ë°©ì‹ê³¼ `tail-based sampling` ë°©ì‹ì„ ì§€ì›í•œë‹¤. ìƒ˜í”Œë§ ê°’ì€ `transaction_sample_rate`Â  ì˜µì…˜ìœ¼ë¡œ ê²°ì •ëœë‹¤. ê¸°ë³¸ ê°’ì€ 1ì´ë©° 100%ë¥¼ ì˜ë¯¸í•œë‹¤. 0.2ë¼ë©´ 20%ë¥¼ ì˜ë¯¸í•œë‹¤. ì†Œìˆ˜ì ì€ ë„¤ ìë¦¬ë§Œ ì§€ì›í•˜ë©° ë„˜ì–´ê°ˆ ê²½ìš° ë°˜ì˜¬ë¦¼í•œë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ `apm agent`ëŠ” `head-based sampling` ë°©ì‹ì„ ì§€ì›í•˜ë©° ì¶”ì ì´ ì‹œì‘ë˜ëŠ” ê²½ìš°ì— ìƒ˜í”Œ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤. ì¦‰ í•´ë‹¹ ê·¸ë¦¼ì—ì„œëŠ” `Service A`ì—ì„œ ìƒ˜í”Œë§ ì—¬ë¶€ê°€ ê²°ì •ëœë‹¤.

![ì°¸ê³  ìë£Œ](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-03_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_9.41.26.png)

[ì°¸ê³  ìë£Œ](https://www.elastic.co/guide/en/observability/8.12/sampling.html#head-based-sampling)


`head-based sampling`ì€ ì´í›„ ì˜¤ë¥˜ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— `Service C`ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ìƒ˜í”Œë§ì´ ë¶ˆê°€í•  ìˆ˜ ìˆë‹¤. ì´ì²˜ëŸ¼ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ìƒ˜í”Œë§ ì¶”ì¶œì´ ì–´ë µê¸° ë•Œë¬¸ì— `tail-based sampling` ë°©ì‹ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.

`tail-based sampling` ë°©ì‹ì€ ì¶”ì ì´ ëë‚œ ë’¤ì— ìƒ˜í”Œ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤. ìƒ˜í”Œë§ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ìš”ì†Œ ì¤‘ í•˜ë‚˜ê°€ ëŠë¦°ì§€ ì—¬ë¶€ì¸ë°, ëŠë¦´ ìˆ˜ë¡ ìƒ˜í”Œë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤. ì´ì²˜ëŸ¼ ì˜ë¯¸ ìˆëŠ” ìƒ˜í”Œì´ ì¶”ì¶œë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-03 á„‹á…©á„’á…® 9.51.15.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-03_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_9.51.15.png)

`tail-based sampling` ë°©ì‹ì˜ ë‹¨ì ì€ APM ì„œë²„ì—ì„œ ìƒ˜í”Œë§ì´ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì— ìš”êµ¬ë˜ëŠ” CPUì™€ ë©”ëª¨ë¦¬ê°€ ë§ë‹¤.  ê²°ê³¼ì ìœ¼ë¡œ ESì— ì „ì†¡ë˜ëŠ” ë°ì´í„° ì–‘ì€ ì ìœ¼ë‹ˆ ES ê´€ë¦¬ ë¶€ë‹´ì€ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

`tail-based sampling` ë°©ì‹ì€ APM ì„œë²„ ì„¤ì •ì´ í•„ìš”í•˜ë©° [í•´ë‹¹ ê¸€](https://www.elastic.co/guide/en/observability/8.12/configure-tail-based-sampling.html)ì—ì„œ ê´€ë ¨ ì„¤ì •ì„ ì§„í–‰í•  ìˆ˜ ìˆë‹¤.

> ğŸš§ `tail-based sampling` ë°©ì‹ì—ì„œ ìš”êµ¬ë˜ëŠ” APM ì„œë²„ ë©”ëª¨ë¦¬ ì–‘ì€ 3GBì´ë©° ì €ì¥ í•œë„ê°€ ë¶€ì¡±í•˜ë©´ `configured storage limit reached.` íŒíŠ¸ë¥¼ ì œê³µí•œë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ ì¸ë±ìŠ¤ ë¼ì´í”„ì‚¬ì´í´ ì„¤ì • ë°©ì‹ì„ ì‚´í´ë³´ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜ëª… ì£¼ê¸°ê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤. ë¡¤ì˜¤ë²„ê°€ ì§„í–‰ë˜ë©´ ì¼ë¶€ ë©”íŠ¸ë¦­ì„ ì§€ìš°ê²Œ ëœë‹¤. ì´ëŸ° í˜•ì‹ì˜ ì¸ë±ìŠ¤ê°€ ìˆìœ¼ë©° ë¡¤ ì˜¤ë²„ê°€ ì§„í–‰ë  ë•Œë§ˆë‹¤ ê´€ë¦¬ëœë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-03 á„‹á…©á„’á…® 10.12.29.png](/static/images/study/elastic-apm/%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2024-07-03_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_10.12.29.png)

ì¸ë±ìŠ¤ ë¼ì´í”„ì‚¬ì´í´ì„ ìˆ˜ì •í•  í•„ìš”ëŠ” ì—†ì—ˆë‹¤. ê° ì¸ë±ìŠ¤ë§ˆë‹¤ ë°ì´í„° ì‚¬ì´ì¦ˆ í•œë„ê°€ 50GBì´ë©°, ì›” ë‹¨ìœ„ë¡œ ê´€ë¦¬ëœë‹¤. ë¡¤ ì˜¤ë²„ê°€ ì§„í–‰ë˜ë©´ 30ì¼ì´ ì§€ë‚œ ë°ì´í„°ë¥¼ ì œê±°í•˜ê³  50GBê°€ ë„˜ì§€ ì•Šë„ë¡ ì •ë¦¬í•˜ê²Œ ëœë‹¤.

í•˜ì§€ë§Œ `tail-based sampling` ë°©ì‹ì€ í•„ìˆ˜ ì¡°ê±´ì´ë‹¤. ì˜¤ë²„ë¡¤ì´ ë˜ë©´ ì´ì „ ê¸°ë¡ ìˆœìœ¼ë¡œ ì‚­ì œë ê±°ê³  ë¶„ì„ ëŒ€ìƒ ë°ì´í„°ê°€ ì‚¬ë¼ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.
ìµœëŒ€í•œ ë¶„ì„ ëŒ€ìƒêµ° ë¹„êµ ëŒ€ìƒêµ° ê°„ì˜ ë¹„ìœ¨ì„ ë§ì¶° ë°ì´í„° ì–‘ì„ ì¤„ì—¬ì•¼ í•œë‹¤.
