---
title: 팀업 백업 서비스 회고
date: '2023-10-30'
tags: ['프로젝트', '회고']
draft: false
summary: 팀업 백업 서비스 구현부터 운영까지
images: []
---

## Introduction

수만명의 사용자가 사용하던 협업툴 운영 종료하면서 필요에 따라 백업 데이터를 생성해 전달하는 서비스를 구축하고 서버를 운영하게 됐어.
그 과정에서 백업 신청한 사용자의 데이터를 조회해 압축하는 과정과 서버를 운영하는 역할을 맡게 됐지.

<TOCInline toc={props.toc} exclude="Introduction" />

## 스프링 배치를 활용한 유연한 기능 변경 경험

사용자들의 백업을 스프링 배치를 활용해 실행 흐름을 자유롭게 풀어갈 수 있는 장점을 활용했어.
스프링 배치를 학습하는 과정에서 나만의 언어로 이해하기 위해 노력했지.

![그림 1](/static/images/project/1.png)

어떻게 작업 할지도 간단하게 다이어그램을 그려봤지.

![그림 2](/static/images/project/2.png)

> 위 그림은 팀원들에게 어떻게 작업할지 공유하기 위해 그린 샘플이야.

그 과정에서 스프링 배치를 사용하지 않고도 충분히 수행 할 수 있지 않냐는 질문을 받았어.
생각해보면 단순한 자바 코드로도 작업들을 수행하는 데 지장이 없었지.
그럼에도 스프링 배치를 활용한 이유는 작업이 독립적으로 관리 가능해 기능 변경에 쉽게 대응할 수 있었기 때문이야.
그리고 컴퓨터 리소스에 대응해 실행 흐름을 자유롭게 설정 할 수 있는 것도 장점이지.

위와 같은 장점은 운영 할 때 두드러졌어.
실패하는 작업은 다른 실행 방법으로 관리가 필요했는데, `retry`를 활용해 쉽게 대응 할 수 있었지.

논리적으로만 생각했던 장점들을 운영에서 경험 할 수 있어서 좋았어.

## 슬로우 쿼리 경험

개발 과정에서 기능 변경 성능 튜닝을 위해 쿼리를 빈번하게 수정했어.
쿼리를 수정 할 때마다 `실행 계획`을 확인 했음에도 불고하고 `슬로우 쿼리`가 발생했어.
원인은 최악의 데이터 셋인 경우의 `실행 계획`을 파악하지 못했던게 컸어.

`UNION` 으로 인해 쿼리 실행 시간이 30초나 걸리기도 했어. ㅋㅋㅋ
슬로우 쿼리의 가장 큰 문제점은 데이터베이스 접근 과정을 병목 지점으로 만드는 일이야.
지속적으로 요청을 보내 커넥션을 재활용 해야 하는데 반환받는게 느리면 어떻겠어.
당연히 문제가 생길 수 밖에 없지.

잘못된 쿼리는 `Connection Timeout` 문제가 따라올 수 밖에 없었어.
이러한 경험 덕분에 실행 시간이 올래 걸리는 경우 쿼리 실행을 종료해 `Read Timeout`을 발생시키고 이후 사용자가 불쾌하지 않도록 실패를 어떻게 처리할지 고민해야 한다는 것을 깨달았지.

그리고 슬로우 쿼리를 확인 할 수 있는 시스템 지표가 있었으면 좋겠다는 생각이 들었어.
슬로우 쿼리가 발생한다는 건 서비스 구현이 70% 되고 나서 개발 환경에서 테스트 할 때 발생했지.
이런 문제를 개선하기 위해 진행율과 실행 시간을 파악할 수 있도록 로그를 찍었어.

```
... 생략
2023-10-11T16:31:33.957+09:00  INFO 1 --- [nPool-worker-30] [percent : 23%]
2023-10-11T16:31:33.709+09:00  INFO 1 --- [nPool-worker-32] [percent : 21%]
2023-10-11T16:31:33.655+09:00  INFO 1 --- [nPool-worker-34] [percent : 19%]
2023-10-11T16:31:33.469+09:00  INFO 1 --- [nPool-worker-25] [percent : 17%]
2023-10-11T16:31:33.452+09:00  INFO 1 --- [or-http-epoll-9] [percent : 14%]
2023-10-11T16:31:33.326+09:00  INFO 1 --- [nPool-worker-29] [percent : 12%]
2023-10-11T16:31:33.133+09:00  INFO 1 --- [nPool-worker-33] [percent : 10%]
2023-10-11T16:31:33.133+09:00  INFO 1 --- [nPool-worker-35] [percent : 8%]
2023-10-11T16:31:33.037+09:00  INFO 1 --- [nPool-worker-22] [percent : 6%]
2023-10-11T16:31:32.296+09:00  INFO 1 --- [nPool-worker-24] [percent : 4%]
2023-10-11T16:31:31.502+09:00  INFO 1 --- [nPool-worker-27] [percent : 2%]
```

쿼리 실행 시간을 측정 할 수 있는 시스템 메트릭 수집 툴을 사용했더라면 더 원만하게 해결 할 수 있어보였어.
덕분에 메트릭에 대한 중요성을 체감하고 다음 프로젝트에서는 맞는 메트릭 툴을 적용하기 위해 이것저것 연습해보고 있어.

지금은 두 개 정도의 메트릭 툴을 학습하고 사용해봤어.
[정리한 위치](https://tis-blog.vercel.app/blog/reminiscence/11m2w) 공유할게.

## 미비했던 성능 튜닝 경험

목표했던 실행 시간 내에 모든 작업을 처리하기 위해서 성능 튜닝이 필요했어.
그래서 빈번하게 발생하는 `파일 I/O`를 해결하기 위해 메모리에 데이터를 적재할 수 있도록 작업 방식을 변경했지.
결과적으로 `파일 I/O` 횟수를 줄일 수 있었지만 실행 시간은

`파일 I/O`를 `1/3`으로 줄였지만 실행 시간이 많이 줄어들지 않았던 문제를 파악하는 [시간](https://tis-blog.vercel.app/blog/reminiscence/9m5w)을 가졌고,
실행 시간을 많이 소유하는 쿼리 실행 시간을 줄이는 [시간](https://tis-blog.vercel.app/blog/reminiscence/10m1w)도 가졌어.

이번 경험을 계기로 성능 개선은 리소스를 효율적으로 사용하는 일임을 깨달았어.
다음부터는 가용할 수 있는 리소스를 파악하고 제품에서 활용 할 수 있을지 판단하는 단계로 접근해야겠어.

## QA를 통한 이해 관계자 간 소통 경험

QA 단계에서 정책과 다른 부분들에 대해서 수정 요청이 많았어. 원인은 크게 두가지야.

- 정책을 제대로 파악하지 못한점
- 개발 단계에서 불편해 보이는 부분은 개선될 수 있도록 공유했지만 모든 이해관계자에게 전파되지 못한점

첫 번째 문제를 해결하기 위해 qa 과정에서 소프트웨어 테스팅 책을 읽었는데, 명세 기반 테스트의 중요성을 체감하게 됐어.
난 정책을 검증하지 못하고 단순하게 코드만 검증하는 테스터였어.
앞으로는 개발 일정에서 요구사항 정제하는 시간을 더 투자할 생각이야.

두 번째는


- 배포가 얼마 남지 않은 시점에서 qa 분의 기능 개선을 요구했음. 사용자 편의성을 중시하기 때문에 요구사항 개선 요청을 수락했음. 그런데 나는 사용자 편의성을 중시하는 것보다 시스템 안정성을 고려해야 하는 포지션이 아닌가를 고민했음.

## 운영

- `Out of heap memory` 이슈를 만났음
- `Batch provider`에서 발생하는 `BadSqlException`도 존재했음

## 회고

- 키 밸류 스토리지로 레디스를 활용함
    - [RocksDB](https://d2.naver.com/helloworld/5053838)를 사용했으면 어땠을까...
    - 영상이 두 달 전에 올라왔으면 사용 했을 텐데 아쉬움
    - 메모리가 가득차서 서버에 문제가 생길까봐 걱정했는데, 그런 걱정을 하지 않아도 됐을텐데

- `코드 말고 정책으로 해결하자`는 의미를 이해하게 됨
    - 나는 가치를 전달하는 사람임. 가치를 빠르고 높게 전달하기 위해서는 어떤 방법이 좋은지 고민해야 함.
    - 그래도 코드한테 지는 기분은 어쩔 수 없나봄. 내가 코드로 문제를 해결하지 못한 것 같은 느낌이라 그런 듯 함.


